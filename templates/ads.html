<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>部署</title>
    <link rel="stylesheet" href="{{ url_for('static', filename= 'css/comm.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename= 'css/jquery.dataTables.css') }}" />
    <script src="{{ url_for('static', filename= 'js/jquery.min.js') }}"></script>
    <script src="{{ url_for('static', filename= 'js/jquery.dataTables.js') }}"></script>
    <style type="text/css">
      .dataTable{text-align: center;}

.black_overlay{
	display: none;
	position: absolute;
	top: 0%;
	left: 0%;
	width: 100%;
	height: 100%;
	background-color: black;
	z-index:1001;
	-moz-opacity: 0.8;
	opacity:.50;+
	filter: alpha(opacity=50);
}
.white_content_small {
	display: none;
	position: absolute;
	top: 10%;
	left: 10%;
	width: 80%;
	height: 80%;
	border: 16px solid lightblue;
	background-color: white;
	z-index:1002;
	overflow: auto;
}
textarea {
            width: 2000px;
            min-height: 1000px;
            padding: 0;
        }
    </style>
  </head>
  <body>

    <!--弹出层时背景层DIV---start-->
<div id="fade" class="black_overlay"></div>
<div id="MyDiv" class="white_content_small">
  <textarea id="logdata"></textarea>
  <button onclick="closelog()">关闭</button>
</div>
<!--弹出层时背景层DIV---end-->


    <div id="nav">
    </div>
    <div class="wrapper">
      <h1>Welcome to Google Ads Solutions</h1>
      <div class="form-list">
        <div class="form-item">
          Google Ads Solutions:
          <select>
            <option value ="baremetal">BareMetal</option>
            <option value ="lego">Lego</option>
          </select>
        </div>
        <div class="form-item">
          <span>Project_ID:</span>
          <input type="text" name="project_id" id="project_id" />
        </div>
        <div class="form-item">
          <span>Bucket:</span>
          <input type="text" name="bucket_name" id="bucket_name" />
        </div>
        <a href="/authorize">授权</a>
        <div class="btn">
          <button id ="create" onclick="create()">创建部署任务</button>
          <!-- <button id ="destroy" onclick="destroy()">Destroy</button> -->
        </div>
        <div>
          <button id ="revoke" onclick="revoke()">Revoke</button>
          <button id ="clear" onclick="clearsession()">ClearSession</button>
        </div>
      </div>
    </div>
    
    <table id="table_id_example" class="display">
      <thead>
          <tr>
              <th>部署ID</th>
              <th>Solution</th>
              <th>项目ID</th>
              <th>创建时间</th>
              <th>更新时间</th>
              <th>当前状态</th>
              <th>操作</th>
          </tr>
      </thead>
      <tbody>
      </tbody>
  </table>

  <script>
    // $(document).ready( function () {
      var table = $('#table_id_example').DataTable({
          ajax : {
            url: "/list_deploy",
            type: "get",
            dataSrc: function(d){
              return d
            }
          }
        });
    // } );
      
    $(document).on("click", "#apply", function() {
      current_data = table.row($(this).closest('tr')).data();
      deploy_id = current_data[0]
      apply(deploy_id);
    });

    $(document).on("click", "#destroy", function() {
      current_data = table.row($(this).closest('tr')).data();
      deploy_id = current_data[0]
      destroy(deploy_id);
    });

    $(document).on("click", "#deploylog", function() {
      current_data = table.row($(this).closest('tr')).data();
      deploy_id = current_data[0]
      deploylog(deploy_id);
    });

    $(document).on("click", "#upgrade", function() {
      current_data = table.row($(this).closest('tr')).data();
      deploy_id = current_data[0]
      upgrade(deploy_id);
    });

    function apply(deploy_id){
      $.ajax({
          url: "/apply",
          type: "post", 
          async: true,
          data: {
            deploy_id: deploy_id
          },
          success: function(res) {
            alert(res);
            table.ajax.reload();
          }
        });
    }

    function destroy(deploy_id) {   
      $.ajax({
        url: "/destroy",
        type: "post",
        async: true,
        data: {
          deploy_id: deploy_id
        },
        success: function(res) {
          alert(res);
          table.ajax.reload();
        }
      });
    }

    function deploylog(deploy_id){
      $.ajax({
          url: "/deploylog",
          type: "post", 
          async: true,
          data: {
            deploy_id: deploy_id
          },
          success: function(res) {
            console.log(res)
            $("#fade").show();
            $("#MyDiv").show();
            $("#logdata").html(res)
          }
        });
    }    

    function closelog(){
      $("#fade").hide();
      $("#MyDiv").hide();
    }

    function upgrade(deploy_id){
      $.ajax({
          url: "/upgrade",
          type: "post", 
          data: {
            deploy_id: deploy_id
          },
          success: function(res) {
            alert(res);
            table.ajax.reload();
          }
        });
    }    


    function create(deploy_id) {
      var project_id = $("#project_id").val().trim();
      var bucket_name = $("#bucket_name").val().trim();
      var solution = $(":selected").val();
      if(project_id !== '' && bucket_name !== ''){
        document.getElementById("create").setAttribute("disabled", true);
        $.ajax({
          url: "/create",
          type: "post", 
          data: {
            project_id: project_id,
            bucket_name: bucket_name,
            solution: solution
          },
          success: function(res) {
            document.getElementById("create").removeAttribute("disabled");
            table.ajax.reload();
            alert('创建任务成功');
          }
        });
      }
      else{
        alert("project id 或者bucket name不能为空")
      }
    }

    function clearsession(){
      $.ajax({
          url: "/clear",
          type: "get",
          success: function(res) {
            alert(res);
          }
        });
    }
    function revoke(){
      $.ajax({
          url: "/revoke",
          type: "get",
          success: function(res) {
            alert(res);
          }
        });
    }    
  </script>
  </body>  
</html>
