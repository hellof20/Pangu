<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Google Pangu Project</title>
    <!-- <link rel="stylesheet" href="{{ url_for('static', filename= 'css/comm.css') }}" /> -->
    <!-- <link rel="stylesheet" href="{{ url_for('static', filename= 'css/jquery.dataTables.css') }}" /> -->
    <link rel="stylesheet" href="{{ url_for('static', filename= 'css/bootstrap.min.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename= 'css/dataTables.bootstrap5.min.css') }}" />
    <script src="{{ url_for('static', filename= 'js/jquery-3.5.1.min.js') }}"></script>
    <script src="{{ url_for('static', filename= 'js/jquery.dataTables.min.js') }}"></script>
    <script src="{{ url_for('static', filename= 'js/dataTables.bootstrap4.min.js') }}"></script>
    <script src="{{ url_for('static', filename= 'js/bootstrap.min.js') }}"></script>
    
  </head>
  <body style="margin-left: 2%; margin-right: 2%;">

    <!-- 创建部署任务弹出框 -->
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Choose one Solution:  </h5>
            <select id = "solution" style="margin-left: 14px; margin-top: 5px;" ></select>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-list">
              <div id="parameter_list"></div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button id ="create" onclick="create()" type="button" class="btn btn-primary">Save</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 查看日志弹出框 -->
    <div class="modal fade" id="exampleModalLong" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
      <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLongTitle">Deploy Log</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <textarea style="width: 100%; height: 600px;" id = "logdata"></textarea>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="closelog()">Close</button>
            <button type="button" class="btn btn-primary" onclick="refreshlog()">Refresh</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 部署任务详情弹出框 -->
    <div class="modal fade" id="detail_data_pop" tabindex="-1" role="dialog" aria-labelledby="detail_data_popTitle" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="detail_data_popTitle">Deploy Parameters</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div id="deploy_id_data"></div>
            <div id="detail_data"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="closelog()">Close</button>
            <button type="button" class="btn btn-primary" onclick="update_parameters()">Update</button>
          </div>
        </div>
      </div>
    </div>


    <h1 align="center" style="margin-bottom: 3%;margin-top: 3%;">Welcome to Google Ads Solutions</h1>



    <h2 style="margin-bottom: 1%;">Create Deploy Task</h2>

    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal" style="margin-bottom: 1%;">
      Click me
    </button> 

    <h2 style="margin-bottom: 1%;">Deploy Task List</h2>

    <table id="table_id_example" class="table table-striped">
      <thead>
          <tr>
              <th>DeployID</th>
              <th>SolutionID</th>
              <th>Email</th>
              <th>CreateTime</th>
              <th>UpdateTime</th>
              <th>Status</th>
              <th>Actions</th>
          </tr>
      </thead>
      <tbody>
      </tbody>
  </table>

  <script>
    var table = $('#table_id_example').DataTable({
        order: [[0, 'desc']],
        ajax : {
          url: "/list_deploy_email",
          type: "get",
          dataSrc: function(d){
            return d
          },
          error: function (xhr, ajaxOptions, thrownError) {
            alert('登录已失效，请重新登录');
            window.location.href='/login';
          }
        }
      });

    $.ajax({
        url: "/list_solution",
        type: "post",
        async: true,
        data: {},
        success: function(res) {
          $("#solution").html(res)
          console.log(res)
          $("#solution").trigger("change")
        }
      });
    
    $("#solution").on("change", function(){
        the_id = $(this).children(":selected").attr("id")
        $.ajax({
          url: "/list_parameter",
          type: "post",
          async: true,
          data: {
            solution_id: the_id
          },
          success: function(res) {
            $("#parameter_list").html(res)
          }
        });
    });

    $(document).on("click", "#apply", function() {
      current_data = table.row($(this).closest('tr')).data();
      deploy_id = current_data[0]
      apply(deploy_id);
    });

    $(document).on("click", "#destroy", function() {
      current_data = table.row($(this).closest('tr')).data();
      deploy_id = current_data[0]
      destroy(deploy_id);
    });

    $(document).on("click", "#deploylog", function() {
      current_data = table.row($(this).closest('tr')).data();
      deploy_id = current_data[0]
      deploylog(deploy_id);
    });

    $(document).on("click", "#upgrade", function() {
      current_data = table.row($(this).closest('tr')).data();
      deploy_id = current_data[0]
      upgrade(deploy_id);
    });

    $(document).on("click", "#describe_deploy", function() {
      current_data = table.row($(this).closest('tr')).data();
      deploy_id = current_data[0]
      describe_deploy(deploy_id);
    });

    function create() {
      var solution = $(":selected").val();
      var parameter_data ={}
      $("#parameter_list input").each(function(){
        parameter_data[this.id] =this.value
      })
      parameter_data['solution_id'] = solution
      $.ajax({
        url: "/create",
        type: "post", 
        data: JSON.stringify(parameter_data),
        contentType: "application/json",
        success: function(res) {
          $('input').val("");
          table.ajax.reload();
          $('#exampleModal').modal('hide')
          alert(res);
        }
      });
    }    

    function update_parameters() {
      var parameter_data ={}
      var deploy_id = $("#deploy_id").val();
      parameter_data['deploy_id'] = deploy_id
      $("#detail_data input").each(function(){
        parameter_data[this.id] =this.value
      })
      $.ajax({
        url: "/update_parameters",
        type: "post", 
        data: JSON.stringify(parameter_data),
        contentType: "application/json",
        success: function(res) {
          table.ajax.reload();
          $('#detail_data_pop').modal('hide')
          alert(res);
          
        }
      });
    }    

    function apply(deploy_id){
      $.ajax({
          url: "/apply",
          type: "post", 
          async: true,
          data: {
            deploy_id: deploy_id
          },
          success: function(res) {
            alert(res);
            table.ajax.reload();
          }
        });
    }

    function destroy(deploy_id) {   
      $.ajax({
        url: "/destroy",
        type: "post",
        async: true,
        data: {
          deploy_id: deploy_id
        },
        success: function(res) {
          alert(res);
          table.ajax.reload();
        }
      });
    }
    
    function describe_deploy(deploy_id){
      $.ajax({
          url: "/describe_deploy",
          type: "post", 
          async: true,
          data: {
            deploy_id: deploy_id
          },
          success: function(res) {
            $("#detail_data").html(res);
            $("#deploy_id_data").html(`
            <div class="input-group mb-3">
            <div class="input-group-prepend">
                <span class="input-group-text">DeployID</span>
            </div>
            <input id='deploy_id' value=`+ deploy_id +` disabled="disabled" type="text" class="form-control" aria-label="Default" aria-describedby="inputGroup-sizing-default">
        </div>
            `);
          }
        });
    }

    function refreshlog(){
      deploylog(deploy_id)
    }

    function deploylog(deploy_id){
      $.ajax({
          url: "/deploylog",
          type: "post", 
          async: true,
          data: {
            deploy_id: deploy_id
          },
          success: function(res) {
            $("#logdata").html(res)
          }
        });
    }    

    function closelog(){
      table.ajax.reload();
    }

    function close_detail(){
      $("#fade").hide();
      $("#detail_div").hide();
    }

    function upgrade(deploy_id){
      $.ajax({
          url: "/upgrade",
          type: "post", 
          data: {
            deploy_id: deploy_id
          },
          success: function(res) {
            alert(res);
            table.ajax.reload();
          }
        });
    } 

    function clearsession(){
      $.ajax({
          url: "/clear",
          type: "get",
          success: function(res) {
            alert(res);
          }
        });
    }
    function revoke(){
      $.ajax({
          url: "/revoke",
          type: "get",
          success: function(res) {
            alert(res);
          }
        });
    }    
  </script>
  </body>  
</html>



<!-- <a href="/authorize">点击登录</a> -->
      <!-- <button id ="revoke" onclick="revoke()">Revoke</button>
      <button id ="clear" onclick="clearsession()">ClearSession</button> -->
